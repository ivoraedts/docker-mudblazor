@page "/carousel"
@page "/carousel/{ItemId:int}"
@using MyApplication.Client.Components
@using MyApplication.Client.Models
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Carousel</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Carousel</MudText>
<MudText Typo="Typo.body1" GutterBottom="true">Show events around the selected date and time:</MudText>
<div style="max-width:500px">
    <MudGrid>
        <MudItem xs="6">
            <MudDatePicker Label="Date:" Date="@_date" Editable="true" DateFormat="dd-MM-yyyy" DateChanged="DateChanged" />
        </MudItem>
        <MudItem xs="6">
            <MudTimePicker Label="Time:" Time="@_time" Editable="true" TimeChanged="TimeChanged" />
        </MudItem>        
    </MudGrid>
</div>
<br/>
    <MudGrid>
        <MudItem xs="6">
            <FocussedEventsCarousel Events="nextEvents" EventsDescription="Next Events" RelativeReturnUrl="@ThisPageUrl"/>
        </MudItem>                
        <MudItem xs="6">
            <FocussedEventsCarousel Events="previousEvents" EventsDescription="Previous Events"  RelativeReturnUrl="@ThisPageUrl"/>
        </MudItem>        
    </MudGrid>

@inject HttpClient Http
@code {
    private List<CalendarEvent> events = new List<CalendarEvent>();
    private DateTime? _date = DateTime.Today;
    private TimeSpan? _time = DateTime.Now.TimeOfDay;
    private DateTime combinedDateTime => _date.HasValue && _time.HasValue ? _date.Value.Date + _time.Value : DateTime.Now;
    private List<CalendarEvent> nextEvents = new List<CalendarEvent>();
    private List<CalendarEvent> previousEvents = new List<CalendarEvent>();
    private const string ThisPageUrl = "carousel";

    [Parameter]
    public int ItemId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var apiUrl = NavigationManager.BaseUri + "api/calendarevent";
        var result = await Http.GetFromJsonAsync<List<CalendarEvent>>(apiUrl);
        if (result != null) 
        {
            events = result;
            
            if (ItemId > 0)
            {
                var returnEvent = events.FirstOrDefault(ev => ev.Id == ItemId);
                if (returnEvent != null)
                {
                    // small hack: the item will be shown on the Next Event page regardless of on which it was first selected.
                    _date = returnEvent.TimeStamp.Date;
                    _time = returnEvent.TimeStamp.TimeOfDay;
                }
                else
                {
                    Snackbar.Add($"cannot find item {ItemId}", Severity.Warning);
                }
            }
            FillCarouselsWithEvents();
        }
    }

    private void DateChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            _date = date;
        }
        FillCarouselsWithEvents();
    }

    private void TimeChanged(TimeSpan? time)
    {
        if (time.HasValue)
        {
            _time = time;
        }
        FillCarouselsWithEvents();
    }

    private void FillCarouselsWithEvents()
    {
        if (_date.HasValue && _time.HasValue)
        {
            nextEvents = events.Where(e => e.TimeStamp >= combinedDateTime).Take(5).ToList();

            previousEvents = events.Where(e => e.TimeStamp < combinedDateTime).Reverse().Take(5).ToList();
        }
    }
}